#!/usr/bin/ruby

require 'rbconfig'

PLATFORM = lambda {
  if RbConfig::CONFIG['target_os'] =~ /windows/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /mingw32/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /cygwin/i
    'cygwin'
  elsif RbConfig::CONFIG['target_os'] =~ /darwin/i
    'macosx'
  elsif RbConfig::CONFIG['target_os'] =~ /linux/i
    'linux'
  elsif RbConfig::CONFIG['target_os'] =~ /bsd/i
    'bsd'
  else
    raise "#{RbConfig::CONFIG['target_os']} is an unknown platform!"
  end
}.call

case ARGV[0]
  when 'debug'
  when 'release'
  else
    raise "`#{ARGV[0]}` is an invalid configuration!\n"
end

WTK_BUILD = ARGV[0]
LIB_BUILD = ARGV[0]
WTK_FOUNDATION_PATH = lambda {
  ARGV.each { |arg|
    if arg =~ /--foundation-path=/
      return arg.gsub(/--foundation-path=/, '')
    end
  }

  'deps/foundation'
}.call

File.open('tup.config', 'w') do |cfg|
  cfg.write "# This file was generated by ./configure #{ARGV.join(' ')}\n\n"
  cfg.write "CONFIG_WTK_BUILD=#{WTK_BUILD}\n"
  cfg.write "CONFIG_WTK_FOUNDATION_PATH=#{WTK_FOUNDATION_PATH}\n"
  cfg.write "CONFIG_FOUNDATION_BUILD=#{LIB_BUILD}\n"

  if PLATFORM == 'windows'
    WINDOWS_SDK_DIR = `"%VCINSTALLDIR%\\vcvarsall.bat" & set WindowsSdkDir`.split('WindowsSdkDir=')[1].strip
    cfg.write "CONFIG_WINDOWS_SDK_DIR=#{WINDOWS_SDK_DIR}\n"
  end
end
